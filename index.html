<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<title>HOROSCOPE</title>

<link rel="stylesheet" type="text/css" href="css/style.css">

<!-- js libraries -->
<script type="text/javascript" src="js/libs/jquery.min.js"></script>
<script type="text/javascript" src="js/libs/device.min.js"></script>
<script type="text/javascript" src="js/libs/three.min.js"></script>
<script type="text/javascript" src="js/libs/tween.min.js"></script>
<script type="text/javascript" src="js/libs/stats.min.js"></script>

<script type="text/javascript" src="js/data/data1.js"></script>
<script type="text/javascript" src="js/data/data2.js"></script>
<script type="text/javascript" src="js/data/StarPosition.js"></script>
<script type="text/javascript" src="js/data/LinePosition.js"></script>

<script type="text/javascript" src="js/main.js"></script>

</head>

<body>
<!-- elements ------------------------------------------------------------------- -->
<!-- main frame -->
<div id="main_frame"></div>
<div id="debug_text"></div>

<!-- shaders ------------------------------------------------------------------- -->
<!-- particleShader -->
<script type="x-shader/x-vertex" id="starParticleVertexShader">

uniform   float amplitude;
uniform   float direction;
attribute float size;

attribute vec3  customColor;
attribute vec3  custompositiona;
attribute vec3  custompositionb;
uniform   float time;

varying vec3  vColor;
varying float fAlpha;

void main() {

	//vColor = customColor;

	vec3 pos = vec3(0,0,0); 

	// small noise  movement
	//pos.x = cos(0 + (position.y/8.0))*1.0; 
	//pos.z = sin(0 + (position.x/8.0))*1.0; 
	//pos.y = sin(0 + (position.z/4.0))*1.0; 

	// morph
	vec3 morphed = vec3( 0.0, 0.0, 0.0 );
	if (direction == 0.0) {
		morphed += ( custompositionb - position ) * amplitude;
	} else {
		morphed += ( custompositiona - position ) * amplitude;
	}
	morphed += position;

	vec4 mvPosition = modelViewMatrix * vec4( morphed, 1.0 );

	//fAlpha = (mvPosition.z+6000.0)/6000.0;
	//fAlpha = 1.0;

	//gl_PointSize = min(150.0, size * ( 150.0 / length( mvPosition.xyz ) ) );
	gl_PointSize = min(150.0, 5.0 * ( 150.0 / length( mvPosition.xyz ) ) );
	//gl_PointSize = 10.0;

	gl_Position = projectionMatrix * mvPosition;

}
</script> <!-- starParticleVertexShader -->

<script type="x-shader/x-fragment" id="starParticleFragmentShader">
uniform vec3 color;
uniform sampler2D texture;

varying vec3 vColor;
varying float fAlpha;

void main() {

	vec4 outColor = texture2D( texture, gl_PointCoord );
	if ( outColor.a < 0.5 ) discard; // alpha be gone
	//outColor = vec4(1,gl_PointCoord.x,0,1);
	gl_FragColor = outColor * vec4( color * vColor.xyz, fAlpha );
	gl_FragColor = outColor;
}
</script> <!-- starParticleFragmentShader -->


<!-- three.js ------------------------------------------------------------------- -->
<script type="text/javascript">

$(function(){
	
	// ----------------------------------------------
	// variablss
	// ----------------------------------------------
	// --- global variables ---
	var Time = {
		frameCount     : 0,
		elapsedTime    : 0,
		deltaTime      : 0,
		currentUpdate  : Date.now(),
		previousUpdate : Date.now()
	}
	
	var Mouse = {
		screenX: -1,
		screenY: -1,
		pageX: -1,
		pageY: -1,
		clientPosX: -1,
		clientPosY: -1,
		offsetX: -1,
		offsetY: -1	
	}
	
	var DeviceMotion = {
		accelerationX: -1.0,
		accelerationY: -1.0,
		accelerationZ: -1.0,
		accelerationIncludeGravityX: -1.0,
		accelerationIncludeGravityY: -1.0,
		accelerationIncludeGravityZ: -1.0,
		rotationRateAlpha: -1.0,
		rotationRateBeta:  -1.0,
		rotationRateGamma: -1.0,
	}
	
	var _worldRotationX = 0.0;
	var _worldRotationY = 0.0;
	
	var _mouseX = 0.0;
	var _mouseY = 0.0;
	var _toMouseX = 0.0;
	var _toMouseY = 0.0;
	
	var _userAgent         = null;
	var _deviceType        = null;
	var _deviceOS          = null;
	var _deviceOrientation = null;
	
	// --- webgl objects ---
	var _camera, _scene, renderer;
	
	var _stats;
	
	// objects
	var _world;
	
	var _bgSphere;
	
	var _starParticle;
	
	var _zodiacStarParticle;
	
	var _zodiacStarLineMesh;
	var _zodiacStarLinePositions;
	var _zodiacStarLineColors;
	var _zodiacStarLineConnectionRate = 0;
	
	// 主要な星座のグラフィックスを表示するプレーン
	var _zodiacGraphicsPlanes = [];
	
	var _zodiacIndex;
	
	
	// 
	var State = {
		isEnabledStarLine: false,
		isEnabledZodiacGraphics: false,
		
	}

	// バナーの縦幅
	var BANNER_HEIGHT = 70;
	
	// ----------------------------------------------
	// functions
	// ----------------------------------------------
	init_deviceInfo ();
	init ();
	init_camera ();
	init_object ();
	init_light ();
	render ();
	
	function init () {
		_renderer = new THREE.WebGLRenderer(
		{
			precision:             'highp',
			alpha:                 false,
			premultipliedAlpha:    true,
			antialias:             false,
			stencil:               true,
			preserveDrawingBuffer: false,
			maxLights:             4
		});
		
		// canvas要素のサイズを指定
		_renderer.setSize(window.innerWidth, window.innerHeight);
		// 背景色を指定
		_renderer.setClearColor(0x001122, 1.0);
		
		$(_renderer.domElement).attr('id', 'main_webgl_canvas');
		$("#main_frame").height(BANNER_HEIGHT).css('overflow', 'hidden').css('position', 'absolute').css('bottom', '0px');

		
		// レンダラーをbodyに追加
		$('#main_frame').append($(_renderer.domElement));
		
		// シーンの作成
		_scene    = new THREE.Scene();
		
		// Stats
		_stats = new Stats ();
		_stats.domElement.style.position = 'fixed';
		_stats.domElement.style.right    = '5px';
		_stats.domElement.style.top      = '5px';
		document.body.appendChild(_stats.domElement);
		
		// ウィンドウサイズが変更された時のイベントを取得
		window.addEventListener ('resize', onWindowResize, false);
	}
	
	function init_camera () {
		// カメラを作成
		_camera = new THREE.PerspectiveCamera( 60, window.innerWidth/window.innerHeight, 0.1, 1000 );
		// カメラの位置を指定
		_camera.position.set(0.0, 0.0, -2.5);
		// カメラの向きを指定
		_camera.lookAt ({x:0, y:0, z:0});
		_scene.add (_camera);
	}
	
	function init_object () {
		
		_world = new THREE.Object3D();
		_scene.add(_world);
		
		// --------------------------------------------------------------------
		// 窓
		var windowGeo = new THREE.PlaneBufferGeometry (1, 1);
		var windowPlaneObj = new THREE.Object3D();
		var windowMat = new THREE.MeshBasicMaterial ({
			color:       0xFFFFFF,
			blending:    THREE.NoBlending,
			transparent: true,	
			side:        THREE.DoubleSide,
			depthTest:   true,
			// opacity:     1.0,
			map:         THREE.ImageUtils.loadTexture("./resources/images/window.jpg", undefined, function(texture){
				var aspect = texture.image.width / texture.image.height;
				windowPlaneObj.scale.set(2, 2/aspect, 1);
			})
		});
		var plane = new THREE.Mesh (windowGeo, windowMat);
		// windowPlaneObj.position.set (0, 0, -2.0);
		// windowPlaneObj.scale.set(2, 2, 2);
		windowPlaneObj.add (plane);
		_scene.add(windowPlaneObj);

		// --------------------------------------------------------------------
		// 星パーティクル
		var starParticleRadiusMax = 80.0;
		var starParticleRadiusMin = 20.0;
		var starParticleGeo = new THREE.Geometry ();
		
		for ( var i = 0; i < Math.floor(data1.length/3); ++i ) {
			var vector = randomSpherePoint (starParticleRadiusMin + Math.random() * (starParticleRadiusMax - starParticleRadiusMin));
			starParticleGeo.vertices.push( vector );
		}
		
		var starParticleTex = THREE.ImageUtils.loadTexture ("./resources/images/particle.png");
		
		// particles
		attributes = {
			size:            { type: 'f',  value: [] },
			custompositiona: { type: 'v3', value: [] },
			custompositionb: { type: 'v3', value: [] },
			customColor:     { type: 'c',  value: [] },
		};
	
		uniforms = {
			amplitude: { type: "f", value: 0.0 },
			color:     { type: "c", value: new THREE.Color( 0xffffff ) },
			texture:   { type: "t", value: starParticleTex },
			time:	   { type: "f", value: 1.0 },
			direction: { type: "f", value: 1.0 },
		};
		
		var starParticleShaderMat = new THREE.ShaderMaterial( {
			uniforms: 		uniforms,
			attributes:     attributes,
			vertexShader:   document.getElementById ('starParticleVertexShader').textContent,
			fragmentShader: document.getElementById ('starParticleFragmentShader').textContent,
	
			blending: 		THREE.AdditiveBlending,
			depthTest: 		false,
			transparent:	true,	
		});
		
		var starParticleMat = new THREE.PointCloudMaterial ({
			size:        2,
			color:       0xFFFFFF,
			blending:    THREE.AdditiveBlending,
  			transparent: true,
			depthTest:   false,
			map:         starParticleTex		
		});
		
		_starParticle = new THREE.PointCloud (starParticleGeo, starParticleShaderMat);
		
		var vertices     = _starParticle.geometry.vertices;
		var values_size  = attributes.size.value;
		var values_color = attributes.customColor.value;
		
		baseSize = [];
		
		for (var v = 0; v < vertices.length; v++) {
			baseSize [v] = 40 + Math.random () * 360;
			
			values_size [v]  = baseSize [v];
			values_color [v] = new THREE.Color (0xFFFFFF);
			
			values_color[ v ].setHSL( 0.55, 0.75 * ( v / vertices.length ), 1.0 );
		}
		
		var values_positiona = attributes.custompositiona.value;
		var values_positionb = attributes.custompositionb.value;
		
		for (var v = 0; v < vertices.length; v++) {
			var index = v * 3;
			
			if (index > data1.length) {
				values_positiona [v] = randomSpherePoint (starParticleRadiusMin + Math.random() * (starParticleRadiusMax - starParticleRadiusMin));
				values_positionb [v] = randomSpherePoint (starParticleRadiusMin + Math.random() * (starParticleRadiusMax - starParticleRadiusMin));
			} else {
				var vector = new THREE.Vector3(data1[index], data1[index+2], data1[index+1]);
				vector.multiplyScalar(2.0);
				values_positiona[ v ] = vector;
	
				var vector = new THREE.Vector3(data2[index], data2[index+2], data2[index+1]);
				//vector.multiplyScalar(170);
				values_positionb[ v ] = vector;
			}
		}
		
		_world.add (_starParticle);
		_starParticle.sortParticles = true;
		
		
		// --------------------------------------------------------------------
		// 主要な星座の星のパーティクル
		var zodiacStarParticleGeo = new THREE.Geometry ();
		for ( var i = 0; i < Math.floor(StarPosition.length/3); ++i ) {
			var index = i * 3;
			var scale = 5.0;
			zodiacStarParticleGeo.vertices.push( new THREE.Vector3 (-StarPosition[index] * scale, StarPosition[index+1] * scale, StarPosition[index+2] * scale));
		}
		
		var zodiacStarParticleMat = new THREE.PointCloudMaterial ({
			size:        1,
			color:       0xBBBBFF,
			blending:    THREE.AdditiveBlending,
  			transparent: true,
			depthTest:   false,
			map:         starParticleTex		
		});
		
		_zodiacStarParticle = new THREE.PointCloud (zodiacStarParticleGeo, zodiacStarParticleMat);
		_world.add (_zodiacStarParticle);
		
		
		// --------------------------------------------------------------------
		// 主要な星座のグラフィックス用プレーン
		var zodiacGraphicsImagePathArray = [];
		zodiacGraphicsImagePathArray.push ("./resources/images/Zodiac_Aries.png");  // 04
		zodiacGraphicsImagePathArray.push ("./resources/images/Zodiac_Taurus.png"); // 05
		zodiacGraphicsImagePathArray.push ("./resources/images/Zodiac_Gemini.png"); // 06
		zodiacGraphicsImagePathArray.push ("./resources/images/Zodiac_Cancer.png"); // 07
		zodiacGraphicsImagePathArray.push ("./resources/images/Zodiac_Leo.png"); // 08
		zodiacGraphicsImagePathArray.push ("./resources/images/Zodiac_Virgo.png"); // 09
		zodiacGraphicsImagePathArray.push ("./resources/images/Zodiac_Libra.png"); // 10
		zodiacGraphicsImagePathArray.push ("./resources/images/Zodiac_Scorpio.png"); // 11
		zodiacGraphicsImagePathArray.push ("./resources/images/Zodiac_Sagittarius.png"); // 12
		zodiacGraphicsImagePathArray.push ("./resources/images/Zodiac_Capricorn.png"); // 01		
		zodiacGraphicsImagePathArray.push ("./resources/images/Zodiac_Aquarius.png"); // 02
		zodiacGraphicsImagePathArray.push ("./resources/images/Zodiac_Pisces.png"); // 03
		
		var zodiacGraphicsPlaneGeo = new THREE.PlaneBufferGeometry (1, 1);
		
		for (var i = 0; i < zodiacGraphicsImagePathArray.length; i++) {
			//console.log (zodiacGraphicsImagePathArray [i]);
			var zoadicGraphicsPlaneObj = new THREE.Object3D();
			
			var zodiacGraphicsPlaneMat = new THREE.MeshBasicMaterial ({
				color:       0xFFFFFF,
				blending:    THREE.AdditiveBlending,
  				transparent: true,
				side:        THREE.DoubleSide,
				depthTest:   false,
				opacity:     0.0,
				map:         THREE.ImageUtils.loadTexture(zodiacGraphicsImagePathArray [i])
			});
			
			var plane = new THREE.Mesh (zodiacGraphicsPlaneGeo, zodiacGraphicsPlaneMat);
			
			var ang = -(Math.PI*2.0/12.0)*i + Math.PI;
			var pos = new THREE.Vector3 (
				6.0 * Math.cos (ang),
				Math.sin (i * 0.5 + 0.91) * 2.8,
				6.0 * Math.sin (ang)
			);
			
			//var rot = Math.asin ((pos.y - _camera.position.y) / (pos.distanceToSquared (_camera.position)));
			var rot = Math.sin (ang) * 0.5;
			console.log (rot * 180.0/Math.PI);
			plane.rotation.set (rot, 0.0, 0.0);
			
			zoadicGraphicsPlaneObj.position.set (pos.x, pos.y, pos.z);
			zoadicGraphicsPlaneObj.rotation.set (Math.PI * 0.0 , -Math.PI * 0.5 - ang, 0.0);
			zoadicGraphicsPlaneObj.scale.set (4,4,4);
			
			zoadicGraphicsPlaneObj.add (plane);
			
			_world.add (zoadicGraphicsPlaneObj);
			
			_zodiacGraphicsPlanes.push ({
				mesh:      plane,
				transform: zoadicGraphicsPlaneObj,
				isVisible: false
			});	
		}
		
		// --------------------------------------------------------------------
		// 主要な星座の星を結ぶライン
		
		// ジオメトリ
		var starLineGeo = new THREE.BufferGeometry ();
		
		var segments = Math.floor(LinePosition.length/6);
		
		_zodiacStarLinePositions = new Float32Array (segments * 3 * 2);
		_zodiacStarLineColors    = new Float32Array (segments * 3 * 2);
		
		starLineGeo.addAttribute ('position', new THREE.DynamicBufferAttribute (_zodiacStarLinePositions, 3));
		starLineGeo.addAttribute ('color',    new THREE.DynamicBufferAttribute (_zodiacStarLineColors,    3));
		
		starLineGeo.computeBoundingSphere ();
		
		starLineGeo.drawcalls.push ({
			star:  0,
			count: 0,
			index: 0
		});
		
		// マテリアル
		var starLineMat = new THREE.LineBasicMaterial({
			vertexColors: THREE.VertexColors,
			blending:     THREE.AdditiveBlending,
			linewidth:    2.0,
			color:        0xAADDFF,
			transparent:  true
		});
		
		_zodiacStarLineMesh = new THREE.Line (starLineGeo, starLineMat, THREE.LinePieces);
		_world.add (_zodiacStarLineMesh);
		
		_zodiacStarLineConnectionRate = 0;
		updateZodiacStarLinePosition (_zodiacStarLineConnectionRate);
		
		// --------------------------------------------------------------------
		/*
		// 背景の球体
		var bgSphereGeo = new THREE.SphereGeometry (101, 12, 12);
		// テクスチャ
		var bgSphereTex = THREE.ImageUtils.loadTexture ('./resources/images/UVTextureChecker2048.png');
		
		var bgSphereMat = new THREE.MeshBasicMaterial (
			{
				color     : 0xFFFFFF,
				wireframe : true,
				map       : bgSphereTex,
				side      : THREE.DoubleSide
			});
		_bgSphere = new THREE.Mesh (bgSphereGeo, bgSphereMat);
		_world.add(_bgSphere);
		*/
		
		// 水平線上の円状のライン
		/*
		var outerHorizontalCircleLineMat = new THREE.LineBasicMaterial ({
			color: 0xFFFFFF
		});
		
		var outerHorizontalCircleLineGeo = new THREE.Geometry ();
		for (var i = 0; i < 48; i++) {
			var ang = (Math.PI * 2.0) / 48.0 * i;
			outerHorizontalCircleLineGeo.vertices.push (
				new THREE.Vector3 (
					40.0 * Math.cos (ang),
					0.0,
					40.0 * Math.sin (ang)
				)
			);
		}
		
	
		var outerHorizontalCircleLine = new THREE.Line (outerHorizontalCircleLineGeo, outerHorizontalCircleLineMat);
		_world.add (outerHorizontalCircleLine);
		*/
		
		// 座標軸
		var axisHelper = new THREE.AxisHelper (1);
		axisHelper.position.set (0,0,0);
		//axisHelper.scale.set(0.01, 0.01, 0.01);
		_world.add (axisHelper);
	}
	
	function init_light () {
		
	}
	
	function render () {
		requestAnimationFrame(render);
		
		_stats.begin ();
		
		Time.currentUpdate  = Date.now ();
		Time.deltaTime      = (Time.currentUpdate - Time.previousUpdate) / 1000.0;
		Time.previousUpdate = Time.currentUpdate;
		
		if (device.portrait()) {
			_deviceOrientation = "portrait";	
		} else if (device.landscape()) {
			_deviceOrientation = "landscape";
		} else {
			
		}
		
		if (_deviceType == "desktop") {
			var windowHalfX = window.innerWidth >> 1;
			var windowHalfY = window.innerHeight >> 1;
	
			_mouseX = ( Mouse.clientPosX - windowHalfX );
			_mouseY = ( Mouse.clientPosY - windowHalfY );
			
			_toMouseX += (_mouseX-_toMouseX)/30;
			_toMouseY += (_mouseY-_toMouseY)/30;
	
			_worldRotationX  = _toMouseY/1000;
			_worldRotationY += _toMouseX/20000;
		} else {
			// rotationRateを使用
			// _worldRotationX += DeviceMotion.rotationRateAlpha * Time.deltaTime * 0.01;
			_worldRotationY -= DeviceMotion.rotationRateBeta * Time.deltaTime * 0.02;

			var gy = (DeviceMotion.accelerationIncludeGravityZ > 0) ? DeviceMotion.accelerationIncludeGravityY + 10.0 : map(DeviceMotion.accelerationIncludeGravityY, -10.0, 0.0, 0.0, -10.0, false);
			var distinationX = map(gy, -10.0, 10.0, -Math.PI * 0.5, Math.PI * 0.5, false);
			_worldRotationX += ( distinationX - _worldRotationX ) * 0.1;
		}
		
		_world.rotation.set (_worldRotationX, _worldRotationY, 0);
		
		// 星座のグラフィックスを表示
		if (State.isEnabledZodiacGraphics) {
			checkIsFitLightOfSightToZodiacGraphicsPlane ();
		}
		
		
		// Tweenの更新
		TWEEN.update();
		
		_renderer.render (_scene, _camera); 
		
		// デバッグテキスト
		// drawDebugText ();
		
		Time.elapsedTime += Time.deltaTime;
		Time.frameCount++;
		
		_stats.end ();
	};
	
	function init_deviceInfo () {
		_userAgent = window.navigator.userAgent.toLowerCase();
		
		if (device.mobile()) {
			_deviceType = "mobile";	
		} else if (device.tablet()) {
			_deviceType = "tablet";
		} else {
			_deviceType = "desktop";
		}
		
		if (device.ios()) {
			_deviceOS = "ios";
		} else if (device.ipad()) {
			_deviceOS = "ipad";
		} else if (device.iphone()) {
			_deviceOS = "iphone";
		} else if (device.ipod()) {
			_deviceOS = "ipod";
		} else if (device.android()) {
			_deviceOS = "android";
		} else if (device.androidPhone()) {
			_deviceOS = "androidPhone";
		} else if (device.androidTablet()) {
			_deviceOS = "androidTablet";
		} else if (device.blackberry()) {
			_deviceOS = "blackberry";
		} else if (device.blackberryTablet()) {
			_deviceOS = "blackberryTablet";
		} else if (device.windows()) {
			_deviceOS = "windows";
		} else if (device.windowsPhone()) {
			_deviceOS = "windowsPhone";
		} else if (device.windowsTablet()) {
			_deviceOS = "windowsTablet";
		} else {
			
		}
		
		if (device.portrait()) {
			_deviceOrientation = "portrait";	
		} else if (device.landscape()) {
			_deviceOrientation = "landscape";
		} else {
			
		}
	}
	
	/**
	 *	演出のスケジュールを開始 (窓から)
	 *
	 */
	function startSchedule () {
		
		// if (スライドされたら)
		
		// 窓を開ける
		
		// 窓の外にでる(窓をカメラの裏に移動)
		
		// ラインを表示
		
		
		// 星座のグラフィックスを表示
		
		// if (星座のグラフィックスをすべて表示したら)
		
		// コピーを表示
		
		// 星座のグラフィックスをフェードアウト
		
		// 星を移動
		
		// 主要な星を移動
		
		// ラインを消す(フェードアウト)
		
		// リンクを表示
	}
	
	function showStarLine () {
		new TWEEN.Tween ({value: _zodiacStarLineConnectionRate})
		.to ({value: 1.0}, 2000)
		.easing (TWEEN.Easing.Quadratic.InOut)
		.onUpdate (function () {
			_zodiacStarLineConnectionRate = this.value;
			updateZodiacStarLinePosition (_zodiacStarLineConnectionRate); // ラインの更新
		})
		.onComplete (function () {
			State.isEnabledZodiacGraphics = true;
		})
		.start ();	
	}
	
	// -----------------------------------------------------------------------------
	/**
	 *  主要な星座の星を結ぶラインの位置を更新
	 *  @param rate : ラインが結ばれている率 (0.0:min ~ 1.0:max)
	 */
	function updateZodiacStarLinePosition (rate_) {
		var vartexPos    = 0;
		var colorpos     = 0;
		var numConnected = 0;
		var lineScale    = 5.0;
		for (var i = 0; i <  Math.floor(LinePosition.length/6); i++) {
			_zodiacStarLinePositions [vartexPos++] = LinePosition [i * 6 + 0] * lineScale * -1.0;
			_zodiacStarLinePositions [vartexPos++] = LinePosition [i * 6 + 1] * lineScale;
			_zodiacStarLinePositions [vartexPos++] = LinePosition [i * 6 + 2] * lineScale;
			
			_zodiacStarLinePositions [vartexPos++] = rate_ * LinePosition [i * 6 + 3] * lineScale * -1.0 + (1.0 - rate_) * LinePosition [i * 6 + 0] * lineScale * -1.0;
			_zodiacStarLinePositions [vartexPos++] = rate_ * LinePosition [i * 6 + 4] * lineScale        + (1.0 - rate_) * LinePosition [i * 6 + 1] * lineScale;
			_zodiacStarLinePositions [vartexPos++] = rate_ * LinePosition [i * 6 + 5] * lineScale        + (1.0 - rate_) * LinePosition [i * 6 + 2] * lineScale;
			
			_zodiacStarLineColors [colorpos++] = 1.0;
			_zodiacStarLineColors [colorpos++] = 1.0;
			_zodiacStarLineColors [colorpos++] = 1.0;

			_zodiacStarLineColors [colorpos++] = 1.0;
			_zodiacStarLineColors [colorpos++] = 1.0;
			_zodiacStarLineColors [colorpos++] = 1.0;
			
			numConnected++;
		}
		
		_zodiacStarLineMesh.geometry.drawcalls[ 0 ].count            = numConnected * 2;
		_zodiacStarLineMesh.geometry.attributes.position.needsUpdate = true;
		_zodiacStarLineMesh.geometry.attributes.color.needsUpdate    = true;
	}
	
	// -----------------------------------------------------------------------------
	/**
	 *  星座のグラフィックスのプレーンが視点の先にあるかをチェックする
	 */
	function checkIsFitLightOfSightToZodiacGraphicsPlane () {
		var angle = roundAngle(_worldRotationY);
		
		var range = (Math.PI * 2.0) / 12.0;
		for (var i = 0; i < 12; i++) {
			if (i * range < angle && (i+1) * range >= angle) {
				var index = Math.abs(11-(i+21)%12);
				_zodiacIndex = index;
				if (_zodiacGraphicsPlanes [index].isVisible == false) {
					_zodiacGraphicsPlanes [index].isVisible = true;
					new TWEEN.Tween (_zodiacGraphicsPlanes [index].mesh.material)
					.to ({opacity: 0.5}, 1000)
					.easing (TWEEN.Easing.Linear.None)
					.start ();
				}
			}
		}
	}
	
	function roundAngle (angle_) {
		return angle_ < 0.0 ? Math.PI * 2.0 + angle_ % (Math.PI * 2.0) : angle_ % (Math.PI * 2.0);
	}
	
	function getRandomPointOnParticles (r) {
		var angle = Math.random() * Math.PI * 2;
		var u = Math.random() * 2 - 1;
	
		var v = new THREE.Vector3(
			Math.cos(angle) * Math.sqrt(1 - Math.pow(u, 2)) * r,
			Math.sin(angle) * Math.sqrt(1 - Math.pow(u, 2)) * r,
			u * r
		);
		return v;
	}
	
	function randomSpherePoint (radius){
		var u = Math.random();
		var v = Math.random();
		var theta = 2 * Math.PI * u;
		var phi   = Math.acos(2 * v - 1);
		var x = radius * Math.sin(phi) * Math.cos(theta);
		var y = radius * Math.sin(phi) * Math.sin(theta);
		var z = radius * Math.cos(phi);
		return new THREE.Vector3 (x, y, z);
	}

	function map(value, inputMin, inputMax, outputMin, outputMax, clamp) {
		var outVal = ((value - inputMin) / (inputMax - inputMin) * (outputMax - outputMin) + outputMin);
		if( clamp ){
			if(outputMax < outputMin){
				if( outVal < outputMax )outVal = outputMax;
				else if( outVal > outputMin )outVal = outputMin;
			}else{
				if( outVal > outputMax )outVal = outputMax;
				else if( outVal < outputMin )outVal = outputMin;
			}
		}
		return outVal;

	}
	
	function onWindowResize() {
		// アスペクト比を設定
		_camera.aspect = window.innerWidth / window.innerHeight;
		// カメラの設定を更新
		_camera.updateProjectionMatrix ();
		// canvas要素のサイズを設定
		_renderer.setSize( window.innerWidth, window.innerHeight );
	}
	
	// ------- Events -------------------------------------------------
	// ------- Mouse Position --------
    function getMouseXY_ie(){ /* IE */
        Mouse.screenX    = event.screenX;
        Mouse.screenY    = event.screenY;
        Mouse.pageX      = event.pageX;
        Mouse.pageY      = event.pageY;
        Mouse.clientPosX = event.clientX;
        Mouse.clientPosY = event.clientY;
        Mouse.offsetX    = event.offsetX;
        Mouse.offsetY    = event.offsetY;
    }
    function getMouseXY(event){ /* Firefox, Netscape */
        Mouse.screenX    = event.screenX;
        Mouse.screenY    = event.screenY;
        Mouse.pageX      = event.pageX;
        Mouse.pageY      = event.pageY;
        Mouse.clientPosX = event.clientX;
        Mouse.clientPosY = event.clientY;
        Mouse.offsetX    = event.offsetX;
        Mouse.offsetY    = event.offsetY;
    }
   	document.onmousemove=(document.all) ? getMouseXY_ie : getMouseXY;
	
	// ------- Touch Event -------
	var startY = 0;
	var startTime = 0;
	var moveY = 0;
	var endTime = 0;
	var isExtend = false;

	function touchStartHandler (e) {
		startY = e.targetTouches[0].clientY;
		moveY = startY;
		startTime = Time.elapsedTime;
	}
	
	function touchMoveHandler (e) {
		moveY = e.targetTouches[0].clientY;
		if (!isExtend)
			scaleBanner(window.innerHeight - moveY - startY + window.innerHeight, 0);
	}
	
	function touchEndHandler (e) {
		
		// showStarLine ();

		if (!isExtend)
		{
			var speed = (startY - moveY) / (Time.elapsedTime - startTime);
			console.log(speed);
			if (speed > 400)
			{
				scaleBanner(window.innerHeight, 400000 / speed);
				isExtend = true;
			}
			else
				scaleBanner(BANNER_HEIGHT, 500);
		}
		startY = 0;
		startTime = 0;
		moveY = 0;
	}
	
	document.getElementById('main_frame').addEventListener ("touchstart", touchStartHandler, false);
	document.getElementById('main_frame').addEventListener ("touchmove",  touchMoveHandler, false);
	document.getElementById('main_frame').addEventListener ("touchend",   touchEndHandler, false);
	
	// ------- Device Motion -------
	function deviceMotion (e)
	{
		e.preventDefault();
		var ac = e.acceleration;
		var ag = e.accelerationIncludingGravity;
		var rt = e.rotationRate;
		
		DeviceMotion.accelerationX               = Number(ac.x);
		DeviceMotion.accelerationY               = Number(ac.y);
		DeviceMotion.accelerationZ               = Number(ac.z);
		DeviceMotion.accelerationIncludeGravityX = Number(ag.x);
		DeviceMotion.accelerationIncludeGravityY = Number(ag.y);
		DeviceMotion.accelerationIncludeGravityZ = Number(ag.z);
		DeviceMotion.rotationRateAlpha           = Number(rt.alpha);
		DeviceMotion.rotationRateBeta            = Number(rt.beta);
		DeviceMotion.rotationRateGamma           = Number(rt.gamma);
	}
	window.addEventListener("devicemotion", deviceMotion);
	
	// ------- KeyEvent -------
	document.onkeyup = function (e) {

		if (!e) e = window.event;
	
		console.log ("keyCode : " + e.keyCode);
	
		switch (e.keyCode) {
			
			// ---------------------------------------------------------
			case 65: // a
				
				new TWEEN.Tween (_camera.position)
				.to ({
					x: 0,
					y: 0,
					z: -30
				}, 5000)
				.easing (TWEEN.Easing.Quadratic.InOut)
				.start();
				
				break;
			
			// ---------------------------------------------------------
			case 83: // s
				
				new TWEEN.Tween (_camera.position)
				.to ({
					x: 0,
					y: 0,
					z: -2.5
				}, 5000)
				.easing (TWEEN.Easing.Quadratic.InOut)
				.start();
				
				break;
			
			// ---------------------------------------------------------
			case 68: // d
			
			
				
				break;
			
			// ---------------------------------------------------------
			case 70: // f
				
				break;
			
			// ---------------------------------------------------------
			case 49: // 1
				
				new TWEEN.Tween (uniforms.amplitude)
				.to ({
					value: 0
				}, 5000)
				.easing (TWEEN.Easing.Quadratic.InOut)
				.start();
				
				break;
			
			// ---------------------------------------------------------
			case 50: // 2
			
				new TWEEN.Tween (uniforms.amplitude)
				.to ({
					value: 1
				}, 5000)
				.easing (TWEEN.Easing.Quadratic.InOut)
				.start();
				
				break;
			
			// ---------------------------------------------------------
			case 51: // 3
				
				new TWEEN.Tween ({value: _zodiacStarLineConnectionRate})
				.to ({value: 1.0}, 2000)
				.easing (TWEEN.Easing.Linear.None)
				.onUpdate (function () {
					_zodiacStarLineConnectionRate = this.value;
					console.log (_zodiacStarLineConnectionRate);
					updateZodiacStarLinePosition (_zodiacStarLineConnectionRate); // ラインの更新
				})
				.start ();
				
				break;
			
			// ---------------------------------------------------------
			case 52: // 4
			
				new TWEEN.Tween ({value: _zodiacStarLineConnectionRate})
				.to ({value: 0.0}, 2000)
				.easing (TWEEN.Easing.Linear.None)
				.onUpdate (function () {
					_zodiacStarLineConnectionRate = this.value;
					console.log (_zodiacStarLineConnectionRate);
					updateZodiacStarLinePosition (_zodiacStarLineConnectionRate); // ラインの更新
				})
				.start ();
				
				break;
				
			// ---------------------------------------------------------
			case 53: // 5
				
				showStarLine ();
				
				break;
				
			case 81: // q
			
				// すべての星座のグラフィックスを表示
				for (var i = 0; i < _zodiacGraphicsPlanes.length; i++) {
					if (_zodiacGraphicsPlanes [i].isVisible == false) {
						_zodiacGraphicsPlanes [i].isVisible = true;
						new TWEEN.Tween (_zodiacGraphicsPlanes [i].mesh.material)
						.to ({opacity: 0.5}, 1000)
						.easing (TWEEN.Easing.Linear.None)
						.start ();
					}
				}
				
				break;
				
			case 87: // w
				
				// すべての星座のグラフィックスを非表示に
				for (var i = 0; i < _zodiacGraphicsPlanes.length; i++) {
					if (_zodiacGraphicsPlanes [i].isVisible == true) {
						_zodiacGraphicsPlanes [i].isVisible = false;
						new TWEEN.Tween (_zodiacGraphicsPlanes [i].mesh.material)
						.to ({opacity: 0.0}, 1000)
						.easing (TWEEN.Easing.Linear.None)
						.start ();
					}
				}
				break;
			
			case 69: // e
			
				break;
				
			case 82: // r
			
				break;
				
			case 84: // t
			
				break;
				
			// ---------------------------------------------------------
			default:
	
				break;
		}
	}
		
	// ------- ------------------------------------------
	function drawDebugText () {
		$('#debug_text').html (
			"Time.deltaTime      : " + Time.deltaTime      + "<br/>" +
			"Time.elapsedTime    : " + Time.elapsedTime    + "<br/>" +
			"Time.frameCount     : " + Time.frameCount     + "<br/>" +
			"Time.currentUpdate  : " + Time.currentUpdate  + "<br/>" +
			"Time.previousUpdate : " + Time.previousUpdate + "<br/>" +
			"Mouse.clientPosX    : " + Mouse.clientPosX    + "<br/>" +
			"Mouse.clientPosY    : " + Mouse.clientPosY    + "<br/>" +
			"_worldRotationX     : " + _worldRotationX     + "<br/>" +
			"_worldRotationY     : " + _worldRotationY     + "<br/>" +
			"deviceType          : " + _deviceType         + "<br/>" +
			"deviceOS            : " + _deviceOS           + "<br/>" +
			"deviceOrientation   : " + _deviceOrientation  + "<br/>" +
			"_zodiacGraphicsPlanes [0] : " + _zodiacGraphicsPlanes [0].isVisible + "<br/>" +
			"_zodiacGraphicsPlanes [1] : " + _zodiacGraphicsPlanes [1].isVisible + "<br/>" + 
			"_zodiacGraphicsPlanes [2] : " + _zodiacGraphicsPlanes [2].isVisible + "<br/>" + 
			"_zodiacGraphicsPlanes [3] : " + _zodiacGraphicsPlanes [3].isVisible + "<br/>" + 
			"_zodiacGraphicsPlanes [4] : " + _zodiacGraphicsPlanes [4].isVisible + "<br/>" + 
			"_zodiacGraphicsPlanes [5] : " + _zodiacGraphicsPlanes [5].isVisible + "<br/>" + 
			"_zodiacGraphicsPlanes [6] : " + _zodiacGraphicsPlanes [6].isVisible + "<br/>" + 
			"_zodiacGraphicsPlanes [7] : " + _zodiacGraphicsPlanes [7].isVisible + "<br/>" + 
			"_zodiacGraphicsPlanes [8] : " + _zodiacGraphicsPlanes [8].isVisible + "<br/>" +
			"_zodiacGraphicsPlanes [9] : " + _zodiacGraphicsPlanes [9].isVisible + "<br/>" + 
			"_zodiacGraphicsPlanes [10] : " + _zodiacGraphicsPlanes [10].isVisible + "<br/>" + 
			"_zodiacGraphicsPlanes [11] : " + _zodiacGraphicsPlanes [11].isVisible + "<br/>" +
			"_worldRotationY%Math.PI : " + roundAngle (_worldRotationY) + "<br/>" +
			"_zodiacIndex : " + _zodiacIndex
		);
	}

	function scaleBanner (bannerHeight, duration) {
		var target = document.getElementById("main_frame");
		var size = {
			height : target.clientHeight
		}
		var target = target;
		var tween = new TWEEN.Tween(size)
		.to({
			height : bannerHeight
		}, duration)
		.easing(TWEEN.Easing.Quadratic.Out)
		.onUpdate(function() {
			target.style.height = size.height + 'px';
		});
		tween.start();
	}

	function shorten() {

	}

});

</script>

</body>
</html>
